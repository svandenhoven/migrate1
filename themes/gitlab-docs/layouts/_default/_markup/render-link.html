<!-- Adapted from https://github.com/bep/portable-hugo-links -->
{{ $link := .Destination }}
{{ $isRemote := strings.HasPrefix $link "http" }}
{{ $isValidRelLink := strings.FindRE `^(?:[a-zA-Z0-9#_/]|\/|\.{1,}).*` $link }}

{{- if and (not $isRemote) ($isValidRelLink) -}}
  {{ $url := urls.Parse .Destination }}
  {{- if $url.Path -}}
    {{ $fragment := "" }}
    {{- with $url.Fragment }}{{ $fragment = printf "#%s" . }}{{ end -}}
    {{- with .Page.GetPage $url.Path }}{{ $link = printf "%s%s" .RelPermalink $fragment }}{{ end }}
  {{ end -}}
{{- else if (not $isValidRelLink ) -}}
  {{ warnf "Invalid link '%s' found for link text '%s' in Markdown file '%s'!" .Destination .Text .Page.File }}
{{- end -}}

<a href="{{ $link | safeURL }}"{{ with .Title}} title="{{ . }}"{{ end }}>{{ .Text | safeHTML }}</a>{{- "" -}}
