{{ $DOCS_IMAGES_ENDPOINT_V1 :=
    "https://gitlab.com/api/v4/projects/1794617/registry/repositories/631635/tags?per_page=100" }}
{{ $DOCS_IMAGES_ENDPOINT_V2 :=
    "https://gitlab.com/api/v4/projects/1794617/registry/repositories/3631228/tags?per_page=100" }}

{{ $preSortedV2Versions := slice }}
{{ $preSortedV1Versions := slice }}
{{ $endpointOneResponse := resources.GetRemote $DOCS_IMAGES_ENDPOINT_V1 }}
{{ $endpointTwoResponse := resources.GetRemote $DOCS_IMAGES_ENDPOINT_V2 }}

{{ if or $endpointOneResponse.Err $endpointTwoResponse.Err }} <!-- If either of the API calls fail, display error banner -->
    <!-- Display danger banner -->
    <div class="docs-error-box">
        <div class="docs-error-icon"></div>
        <div>Archives list could not be loaded, please try again later.</div>
    </div>
{{ else }}
    <!-- Version 2 - version gathering -->
    {{ $responseDataV2 := $endpointTwoResponse | transform.Unmarshal }}
    {{ range $responseDataV2 }}
        {{ if eq (partial "functions/is-stable-version" (dict "version" .name)) "true" }} <!-- Remove strings and only keep numerical versions -->
            {{ $preSortedV2Versions = $preSortedV2Versions | append .name }}
        {{ end }}
    {{ end }}

    <!-- Sort versions in descending order: Version 2 -->
    {{ $numbers := $preSortedV2Versions }}
    {{ $padded := apply $numbers "partial" "functions/padZeroPrefix.html" "." }}
    {{ $sorted := sort $padded "value" "desc" }}
    {{ $results := apply $sorted "partial" "functions/trimZeroPrefix.html" "." }}

    {{ $finalSlice := slice }}
    {{ range $eachSortedVersion := $results}}
        {{ range $eachVersion := $responseDataV2 }}
            {{ if eq $eachSortedVersion $eachVersion.name }}
                {{ $finalSlice = $finalSlice | append $eachVersion }}
            {{ end }}
        {{ end }}
    {{ end }}

    {{ range $finalSlice }}
        {{ $splitStr := split .name "." }}
        {{ $mainVersion := cast.ToInt (index $splitStr 0) }}
        {{ $subVersion := cast.ToInt (index $splitStr 1) }}

        {{ if or (and (eq $mainVersion 15) (ge $subVersion 6)) (gt $mainVersion 15) }}
          {{- partial "archiveItem.html" . -}}
        {{ end }}
    {{ end }}

    <!-- Version 1 - version gathering -->
    {{ $responseDataV1 := $endpointOneResponse | transform.Unmarshal}}
    {{ range $responseDataV1 }}
        {{ if eq (partial "functions/is-stable-version" (dict "version" .name)) "true" }} <!-- Remove strings and only keep numerical versions -->
            {{ $preSortedV1Versions = $preSortedV1Versions | append .name }}
        {{ end }}
    {{ end }}

    <!-- Sort versions in descending order: Version 1 -->
    {{ $numbers := $preSortedV1Versions }}
    {{ $padded := apply $numbers "partial" "functions/padZeroPrefix.html" "." }}
    {{ $sorted := sort $padded "value" "desc" }}
    {{ $results := apply $sorted "partial" "functions/trimZeroPrefix.html" "." }}

    {{ $finalSlice := slice }}
    {{ range $eachSortedVersion := $results}}
        {{ range $eachVersion := $responseDataV1 }}
            {{ if eq $eachSortedVersion $eachVersion.name }}
                {{ $finalSlice = $finalSlice | append $eachVersion }}
            {{ end }}
        {{ end }}
    {{ end }}

    {{ range $finalSlice }}
        {{ $splitStr := split .name "." }}
        {{ $mainVersion := cast.ToInt (index $splitStr 0) }}
        {{ $subVersion := cast.ToInt (index $splitStr 1) }}

        {{ if or (lt $mainVersion 15) (and (eq $mainVersion 15) (lt $subVersion 6)) }}
          {{- partial "archiveItem.html" . -}}
        {{ end }}
    {{ end }}
{{ end }}
